# setup 
```{r}
library(tidyverse)
library(readr)
library(dplyr)
library(randomForest)
library(tidymodels)
library(skimr)
library(yardstick)
library(caret)
library(mlr)
library(parsnip)
```

# loading data 
```{r}
tester <- read.csv("data/daymet/finalWeatherandRegions.csv")
```

# wrangling data
 ```{r}
 field_data <- tester %>%
  mutate_if(is.character, as.factor) %>%
  dplyr::select(-irrigation) %>%
  drop_na()

```

# splitting data 
```{r}
set.seed(123)
# Put 80% of the data into the training set 
data_split <- initial_split(field_data, strata = "str_emmean", prop = 0.80)
# Create data frames for the two sets:
train_data <- training(data_split)
test_data  <- testing(data_split) 

```

# USING varImp() 
## REMOVING YEAR: MONTHLY MODEL HAD THE BEST STATS 
```{r}
# random forest 
months <- train_data %>%
  dplyr::select(c(srad_mean_April:prcp_sum_November), str_emmean, state, region)
  # year was at the top for varimp s

rf_mod <- randomForest(
  x = dplyr::select(months, -str_emmean),
  y = months$str_emmean,
  mtry = 4,
  ntree = 100,
  importance = TRUE
)

# returning variable imporantance (most important -> least)
varImp <- varImp(rf_mod) %>%
  as.data.frame() %>% 
  tibble::rownames_to_column(var = "variable") %>% 
  arrange(desc(Overall))# overall is average importance across all trees 

# plot 
varImpPlot(rf_mod, type=2, main = "Variable Importance Plot: Monthly")
# plot showing %IncMSE & IncNodePurity
varImpPlot(rf_mod , sort = TRUE , n.var=10 , main = "Variable Importance: Monthly" )


##### REMOVE YEAR ############# 
months_noyear <- train_data %>%
  dplyr::select(c(srad_mean_April:prcp_sum_November), str_emmean, state, region)

rf_noyear <- randomForest(
    x = dplyr::select(months_noyear, -str_emmean),
    y = months$str_emmean,
    mtry=4,
    ntree=100,
    importance = TRUE
)

varImp_noyear <- varImp(rf_noyear) %>%
  as.data.frame() %>% 
  tibble::rownames_to_column(var = "variable") %>% 
  arrange(desc(Overall))

# dayl_mean_Sep
# tamp_mean_Aug
# tmin_mean_Nov
# tmax_mean_June
# gdd_sum_Oct
# srad_sum _April 
# ( i would say maybe temperature has the highest factor out of all? specially TAMP)
 ```



## AFTER REMOVING YEAR: ALL TEMPORAL SCALE HAD THE BEST STATS
```{r}
set.seed(123)
preds <- train_data %>%
  dplyr::select(-loc, -year)


rf_all_mod <- randomForest(
  x = dplyr::select(preds, -str_emmean),
  y = preds$str_emmean,
  mtry = 4,
  ntree = 100,
  importance = TRUE
)


train_predictions <- train_data %>%
  predict(rf_all_mod, .) %>%
  bind_cols(actual = train_data$str_emmean) %>%
  mutate(residuals = actual - .)

R2(train_predictions$.pred, train_data$str_emmean)
RMSE(train_predictions$.pred, train_data$str_emmean)

# returning variable imporantance (most important -> least)
varImp_all <- varImp(rf_all_mod) %>%
  as.data.frame() %>% 
  tibble::rownames_to_column(var = "variable") %>% 
  arrange(desc(Overall))# overall is average importance across all trees 

# plot 
varImpPlot(rf_all_mod, type=2, main)
# plot showing %IncMSE & IncNodePurity
varImpPlot(rf_all_mod , sort = TRUE , n.var=10 , main = "Variable Importance: All Temporal Scales" )

#                                        variable    Overall
#1                              gdd_sum_November  4.4389873
#2                                tamp_mean_July  4.2799157
#3                            gdd_mean_June_July  4.1157730
#4                        gdd_mean_growingseason  3.9875056
#5                            srad_sum_September  3.8805598
```


# using vip() from parsnip package 
```{r}
# random forest 
rf_parsnip <- rand_forest(mode = "regression",  mtry = 90, trees = 35)
```

## monthly
```{r}
rf_monthly_fit <- rf_parsnip %>%
  set_engine("randomForest") %>%
  fit_xy(
    x = dplyr::select(months, -str_emmean),
    y = months$str_emmean # resuse months 
  )

varImp_data_monthly <- vip(rf_monthly_fit) %>%
  .$data %>%
  arrange(desc(Importance))

```

# entire temporal scale
```{r}
rf_entirescale_fit <-  rf_parsnip %>%
  set_engine("randomForest") %>%
  fit_xy(
    x = dplyr::select(preds, -str_emmean),
    y = preds$str_emmean
  )

varImp_data_entirescale <- vip(rf_entirescale_fit) %>%
    .$data %>%
    arrange(desc(Importance))
```


